<style>
    /* Responsive styles for topbar */
    @media (max-width: 768px) {
      .topbar-container {
        width: calc(100% - 64px) !important;
        left: 64px !important;
        padding: 0.5rem !important;
      }
      .topbar-search {
        display: none !important;
      }
      .topbar-icons {
        display: flex !important;
        gap: 0.5rem !important;
      }
      .topbar-back-btn {
        display: block !important;
      }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .topbar-container {
        width: calc(100% - 16.666667%) !important;
        left: 16.666667% !important;
        padding: 0.75rem !important;
      }
    }

    @media (min-width: 1025px) {
      .topbar-container {
        width: calc(100% - 16.666667%) !important;
        left: 16.666667% !important;
        padding: 1rem !important;
      }
    }
</style>

<div
    class="topbar-container flex items-center top-0 w-full fixed z-50 justify-between mb-10 py-4 pl-2 pr-8 border-b border-gray-800 bg-black">
    <!-- Back Button -->
    <button class="topbar-back-btn bg-[#F5F5F51A] p-1 pr-3 pl-3 rounded-lg flex items-center justify-center md:flex">
        <i class="fas fa-arrow-left text-white text-lg"></i>
    </button>

    <!-- Search Bar -->
    <div class="topbar-search flex-grow mx-4 hidden md:block">
        <div class="relative">
            <input type="search" placeholder="Search orders, account, pickups ..."
                class="w-full bg-[#F5F5F51A] text-white rounded-full pl-10 pr-4 py-2 focus:outline-none text-sm lg:text-base" />
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
    </div>

    <!-- Mobile Search Icon (visible only on mobile) -->
    <button class="bg-[#F5F5F51A] p-2 rounded-lg flex items-center justify-center md:hidden">
        <i class="fas fa-search text-white text-lg"></i>
    </button>

    <!-- Icons with Badges -->
    <div class="topbar-icons flex items-center space-x-2 md:space-x-4">

        <!-- Impersonation Pill (hidden by default) -->
        <div id="impersonationPill"
            class="hidden bg-blue-600/20 text-blue-300 border border-blue-500/30 px-2 md:px-3 py-1 rounded-full text-xs md:text-sm flex items-center space-x-1 md:space-x-2">
            <span id="impersonationText" class="hidden sm:inline">Viewing as —</span>
            <span id="impersonationTextMobile" class="sm:hidden">View as —</span>
            <button id="exitImpersonationBtn" class="underline hover:text-blue-200 text-xs md:text-sm">Exit</button>
        </div>

        <!-- Notification -->
        <div class="relative">
            <a href="notification.html" class="bg-[#F5F5F51A] p-2 rounded-lg flex items-center justify-center">
                <img src="../images/notification.svg" alt="">
            </a>
            <span
                class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                3
            </span>
        </div>

        <!-- Branches -->
        <div class="relative">
            <a href="branches.html" class="bg-[#F5F5F51A] p-2 rounded-full flex items-center justify-center">
                <img src="../images/fluent_branch-24-regular.png" alt="Branches">
            </a>
            <span id="branchCount"
                class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                0
            </span>
        </div>

        <!-- Avatar Dropdown -->
        <div class="relative shadow-lg" x-data="{ open: false }">
            <button @click="open = !open">
                <img src="../images/Rectangle 6166.svg"
                    class="w-8 h-8 md:w-10 md:h-10 rounded-full border border-gray-700" />
            </button>
            <div x-show="open" @click.away="open = false"
                class="absolute right-0 mt-2 w-40 md:w-48 bg-black text-white rounded-lg shadow-lg border border-gray-700 z-50">
                <a href="profile.html" class="block px-3 md:px-4 py-2 hover:bg-blue-600 text-sm md:text-base">Set
                    Profile</a>
                <a href="branches.html" class="block px-3 md:px-4 py-2 hover:bg-blue-600 text-sm md:text-base">Add/view
                    Branches</a>
                <a href="add_products.html" class="block px-3 md:px-4 py-2 hover:bg-blue-600 text-sm md:text-base">Add
                    Products</a>
                <a href="account_verification.html"
                    class="block px-3 md:px-4 py-2 hover:bg-blue-600 text-sm md:text-base">Verification</a>
                <a href="workspace.html"
                    class="block px-3 md:px-4 py-2 hover:bg-blue-600 text-sm md:text-base">Workspace</a>
                <a href="login_details.html" class="block px-3 md:px-4 py-2 hover:bg-blue-600 text-sm md:text-base">See
                    Login Details</a>
                <a href="#" class="block logout-btn px-3 md:px-4 py-2 hover:bg-blue-600 text-sm md:text-base">Log
                    out</a>
            </div>
        </div>
    </div>
</div>

<script>
    // Hide branches access for branch role when canSwitchRole is false
    (function () {
        function shouldRestrictBranches() {
            try {
                const role = (sessionStorage.getItem('activeRole') || localStorage.getItem('activeRole') || '').toLowerCase();
                const canSwitchRaw = localStorage.getItem('canSwitchRole');
                const canSwitch = !(canSwitchRaw === 'false' || canSwitchRaw === '0' || canSwitchRaw === null);
                return role === 'branch' && !canSwitch;
            } catch (_) { return false; }
        }

        function hideBranchesUI() {
            try {
                // Icon + badge
                const iconLink = document.querySelector('a[href="branches.html"]');
                if (iconLink) {
                    const container = iconLink.closest('.relative') || iconLink;
                    if (container) container.style.display = 'none';
                }
                const badge = document.getElementById('branchCount');
                if (badge) badge.style.display = 'none';

                // Dropdown item
                document.querySelectorAll('a[href="branches.html"]').forEach(a => {
                    const item = a.closest('a, li, .block');
                    (item || a).style.display = 'none';
                });

                // Defensive: block navigation if any remaining link is clicked
                document.addEventListener('click', function (e) {
                    const link = e.target.closest('a[href="branches.html"]');
                    if (link) {
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    }
                }, true);
            } catch (_) { }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                if (shouldRestrictBranches()) hideBranchesUI();
            });
        } else {
            if (shouldRestrictBranches()) hideBranchesUI();
        }
    })();
</script>
<!-- Appwrite SDK (CDN version for global access) -->
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
<script src="topbar.js" defer></script>