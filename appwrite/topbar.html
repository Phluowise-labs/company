<div
    class="flex items-center top-0 w-5/6 fixed z-50 justify-between mb-10 py-4 pl-2 pr-8 border-b border-gray-800 bg-black">
    <!-- Back Button -->
    <button class="bg-[#F5F5F51A] p-1 pr-3 pl-3 rounded-lg flex items-center justify-center">
        <i class="fas fa-arrow-left text-white text-lg"></i>
    </button>

    <!-- Search Bar -->
    <div class="flex-grow mx-4">
        <div class="relative">
            <input type="search" placeholder="Search orders, account, pickups ..."
                class="w-full bg-[#F5F5F51A] text-white rounded-full pl-10 pr-4 py-2 focus:outline-none" />
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
    </div>

    <!-- Icons with Badges -->
    <div class="flex items-center space-x-4">

        <!-- Impersonation Pill (hidden by default) -->
        <div id="impersonationPill"
            class="hidden bg-blue-600/20 text-blue-300 border border-blue-500/30 px-3 py-1 rounded-full text-xs md:text-sm flex items-center space-x-2">
            <span id="impersonationText">Viewing as â€”</span>
            <button id="exitImpersonationBtn" class="underline hover:text-blue-200">Exit</button>
        </div>

        <!-- Notification -->
        <div class="relative">
            <a href="notification.html" class="bg-[#F5F5F51A] p-2 rounded-lg flex items-center justify-center">
                <img src="../images/notification.svg" alt="">
            </a>
            <span
                class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                3
            </span>
        </div>

        <!-- Branches -->
        <div class="relative">
            <a href="branches.html" class="bg-[#F5F5F51A] p-2 rounded-full flex items-center justify-center">
                <img src="../images/fluent_branch-24-regular.png" alt="Branches">
            </a>
            <span id="branchCount"
                class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                0
            </span>
        </div>

        <!-- Avatar Dropdown -->
        <div class="relative shadow-lg" x-data="{ open: false }">
            <button @click="open = !open">
                <img src="../images/Rectangle 6166.svg" class="w-10 h-10 rounded-full border border-gray-700" />
            </button>
            <div x-show="open" @click.away="open = false"
                class="absolute right-0 mt-2 w-48 bg-black text-white rounded-lg shadow-lg border border-gray-700 z-50">
                <a href="profile.html" class="block px-4 py-2 hover:bg-blue-600">Set Profile</a>
                <a href="branches.html" class="block px-4 py-2 hover:bg-blue-600">Add/view Branches</a>
                <a href="add_products.html" class="block px-4 py-2 hover:bg-blue-600">Add Products</a>
                <a href="account_verification.html" class="block px-4 py-2 hover:bg-blue-600">Verification</a>
                <a href="workspace.html" class="block px-4 py-2 hover:bg-blue-600">Workspace</a>
                <a href="login_details.html" class="block px-4 py-2 hover:bg-blue-600">See Login Details</a>
                <a href="#" class="block logout-btn px-4 py-2 hover:bg-blue-600">Log out</a>
            </div>
        </div>
    </div>
</div>

<script>
    // Hide branches access for branch role when canSwitchRole is false
    (function () {
        function shouldRestrictBranches() {
            try {
                const role = (sessionStorage.getItem('activeRole') || localStorage.getItem('activeRole') || '').toLowerCase();
                const canSwitchRaw = localStorage.getItem('canSwitchRole');
                const canSwitch = !(canSwitchRaw === 'false' || canSwitchRaw === '0' || canSwitchRaw === null);
                return role === 'branch' && !canSwitch;
            } catch (_) { return false; }
        }

        function hideBranchesUI() {
            try {
                // Icon + badge
                const iconLink = document.querySelector('a[href="branches.html"]');
                if (iconLink) {
                    const container = iconLink.closest('.relative') || iconLink;
                    if (container) container.style.display = 'none';
                }
                const badge = document.getElementById('branchCount');
                if (badge) badge.style.display = 'none';

                // Dropdown item
                document.querySelectorAll('a[href="branches.html"]').forEach(a => {
                    const item = a.closest('a, li, .block');
                    (item || a).style.display = 'none';
                });

                // Defensive: block navigation if any remaining link is clicked
                document.addEventListener('click', function (e) {
                    const link = e.target.closest('a[href="branches.html"]');
                    if (link) {
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    }
                }, true);
            } catch (_) { }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                if (shouldRestrictBranches()) hideBranchesUI();
            });
        } else {
            if (shouldRestrictBranches()) hideBranchesUI();
        }
    })();
</script>
<script src="topbar.js" defer type="module"></script>