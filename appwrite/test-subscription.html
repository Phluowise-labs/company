<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription System Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .countdown-timer {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
    </style>
</head>

<body class="bg-black text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold mb-8 text-center">Subscription System Test</h1>

        <!-- Status Display -->
        <div class="bg-zinc-800 rounded-3xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Current Status</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-zinc-900 rounded-2xl p-4">
                    <div class="text-gray-400 text-sm">Status</div>
                    <div class="text-xl font-bold" id="status-display">Loading...</div>
                </div>
                <div class="bg-zinc-900 rounded-2xl p-4">
                    <div class="text-gray-400 text-sm">Plan</div>
                    <div class="text-xl font-bold" id="plan-display">Loading...</div>
                </div>
                <div class="bg-zinc-900 rounded-2xl p-4">
                    <div class="text-gray-400 text-sm">Amount Owing</div>
                    <div class="text-xl font-bold text-red-400" id="amount-display">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Countdown Display -->
        <div class="bg-zinc-800 rounded-3xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Countdown Timers</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-zinc-900 rounded-2xl p-4">
                    <div class="text-gray-400 text-sm">Trial/Plan Countdown</div>
                    <div class="text-2xl font-bold countdown-timer text-blue-400" id="main-countdown">Loading...</div>
                </div>
                <div class="bg-zinc-900 rounded-2xl p-4">
                    <div class="text-gray-400 text-sm">Payment Countdown</div>
                    <div class="text-2xl font-bold countdown-timer text-red-400" id="payment-countdown">No payment due
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="bg-zinc-800 rounded-3xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Test Controls</h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <button onclick="setFreeTrial()"
                    class="bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-semibold transition">
                    Free Trial
                </button>
                <button onclick="setBasicPlan()"
                    class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition">
                    Basic Plan
                </button>
                <button onclick="setExpiredPlan()"
                    class="bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-semibold transition">
                    Expired
                </button>
                <button onclick="setOverduePayment()"
                    class="bg-orange-600 hover:bg-orange-700 text-white py-3 px-4 rounded-lg font-semibold transition">
                    Payment Due
                </button>
                <button onclick="setTrulyOverdue()"
                    class="bg-red-700 hover:bg-red-800 text-white py-3 px-4 rounded-lg font-semibold transition">
                    Truly Overdue
                </button>
                <button onclick="resetSystem()"
                    class="bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-lg font-semibold transition">
                    Reset
                </button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="bg-zinc-800 rounded-3xl p-6">
            <h2 class="text-2xl font-bold mb-4">Actions</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="makePayment()"
                    class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-semibold transition">
                    <i class="fas fa-credit-card mr-2"></i>Make Payment
                </button>
                <button onclick="checkPayment()"
                    class="bg-gray-600 hover:bg-gray-700 text-white py-3 px-6 rounded-lg font-semibold transition">
                    <i class="fas fa-sync-alt mr-2"></i>Check Payment
                </button>
                <button onclick="goToSubscription()"
                    class="bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-semibold transition">
                    <i class="fas fa-cog mr-2"></i>Subscription Page
                </button>
            </div>
        </div>
    </div>

    <!-- Load Subscription Manager -->
    <script src="subscription-manager.js"></script>

    <script>
        let subscriptionManager = null;

        // Wait for subscription manager to be available
        function waitForManager() {
            return new Promise((resolve) => {
                const checkManager = setInterval(() => {
                    if (window.subscriptionManager) {
                        clearInterval(checkManager);
                        subscriptionManager = window.subscriptionManager;
                        resolve();
                    }
                }, 100);
            });
        }

        // Initialize the test page
        async function initTestPage() {
            try {
                await waitForManager();
                updateDisplay();
                startDisplayUpdates();
                console.log('Test page initialized successfully');
            } catch (error) {
                console.error('Failed to initialize test page:', error);
            }
        }

        // Update the display
        function updateDisplay() {
            if (!subscriptionManager || !subscriptionManager.subscriptionData) return;

            const data = subscriptionManager.subscriptionData;

            // Update status displays
            document.getElementById('status-display').textContent = data.status.replace('_', ' ').toUpperCase();
            document.getElementById('plan-display').textContent = data.plan.charAt(0).toUpperCase() + data.plan.slice(1);
            document.getElementById('amount-display').textContent = `GHâ‚µ ${data.amountOwing.toFixed(2)}`;

            // Update countdowns
            updateCountdowns();
        }

        // Update countdown displays
        function updateCountdowns() {
            if (!subscriptionManager || !subscriptionManager.subscriptionData) return;

            const data = subscriptionManager.subscriptionData;

            // Main countdown (trial or plan)
            let mainCountdown = 'No active countdown';
            if (data.status === 'free_trial' && data.trialEnd) {
                const timeLeft = new Date(data.trialEnd) - new Date();
                if (timeLeft > 0) {
                    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    mainCountdown = `${days}d ${hours}h remaining`;
                } else {
                    mainCountdown = 'Trial Expired';
                }
            } else if (data.status === 'active' && data.planEnd) {
                const timeLeft = new Date(data.planEnd) - new Date();
                if (timeLeft > 0) {
                    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    mainCountdown = `${days}d ${hours}h remaining`;
                } else {
                    mainCountdown = 'Plan Expired';
                }
            }

            document.getElementById('main-countdown').textContent = mainCountdown;

            // Payment countdown
            let paymentCountdown = 'No payment due';
            if (data.paymentDueDate) {
                const timeLeft = new Date(data.paymentDueDate) - new Date();
                if (timeLeft > 0) {
                    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    paymentCountdown = `${hours}h ${minutes}m remaining`;
                } else {
                    paymentCountdown = 'PAYMENT OVERDUE';
                }
            }

            document.getElementById('payment-countdown').textContent = paymentCountdown;
        }

        // Start periodic display updates
        function startDisplayUpdates() {
            setInterval(() => {
                updateCountdowns();
            }, 1000);
        }

        // Test functions
        function setFreeTrial() {
            if (!subscriptionManager) return;
            subscriptionManager.subscriptionData = {
                status: 'free_trial',
                plan: 'free',
                trialStart: new Date().toISOString(),
                trialEnd: new Date(Date.now() + (20 * 24 * 60 * 60 * 1000)).toISOString(),
                planStart: null,
                planEnd: null,
                amountOwing: 0,
                lastPaymentCheck: new Date().toISOString(),
                paymentDueDate: null,
                isBlocked: false,
                paymentHistory: []
            };
            subscriptionManager.saveSubscriptionData();
            subscriptionManager.checkAccessControl();
            updateDisplay();

            Swal.fire({
                title: 'Free Trial Set',
                text: '20-day free trial activated',
                icon: 'success'
            });
        }

        function setBasicPlan() {
            if (!subscriptionManager) return;
            subscriptionManager.subscriptionData = {
                status: 'active',
                plan: 'basic',
                trialStart: null,
                trialEnd: null,
                planStart: new Date().toISOString(),
                planEnd: new Date(Date.now() + (30 * 24 * 60 * 60 * 1000)).toISOString(),
                amountOwing: 0,
                lastPaymentCheck: new Date().toISOString(),
                paymentDueDate: null,
                isBlocked: false,
                paymentHistory: []
            };
            subscriptionManager.saveSubscriptionData();
            subscriptionManager.checkAccessControl();
            updateDisplay();

            Swal.fire({
                title: 'Basic Plan Set',
                text: 'Basic plan activated for 30 days',
                icon: 'success'
            });
        }

        function setExpiredPlan() {
            if (!subscriptionManager) return;
            subscriptionManager.subscriptionData = {
                status: 'expired',
                plan: 'basic',
                trialStart: null,
                trialEnd: null,
                planStart: new Date(Date.now() - (31 * 24 * 60 * 60 * 1000)).toISOString(),
                planEnd: new Date(Date.now() - (1 * 24 * 60 * 60 * 1000)).toISOString(),
                amountOwing: 0,
                lastPaymentCheck: new Date().toISOString(),
                paymentDueDate: null,
                isBlocked: true,
                blockedAt: new Date().toISOString(),
                paymentHistory: []
            };
            subscriptionManager.saveSubscriptionData();
            subscriptionManager.checkAccessControl();
            updateDisplay();

            Swal.fire({
                title: 'Expired Plan Set',
                text: 'Plan expired - app should be blocked',
                icon: 'warning'
            });
        }

        function setOverduePayment() {
            if (!subscriptionManager) return;
            subscriptionManager.subscriptionData = {
                status: 'active',
                plan: 'basic',
                trialStart: null,
                trialEnd: null,
                planStart: new Date(Date.now() - (15 * 24 * 60 * 60 * 1000)).toISOString(),
                planEnd: new Date(Date.now() + (15 * 24 * 60 * 60 * 1000)).toISOString(),
                amountOwing: 150.00,
                lastPaymentCheck: new Date().toISOString(),
                paymentDueDate: new Date(Date.now() + (2 * 60 * 60 * 1000)).toISOString(), // 2 hours in the future
                isBlocked: false, // Not blocked yet since payment is not overdue
                paymentHistory: []
            };
            subscriptionManager.saveSubscriptionData();
            subscriptionManager.checkAccessControl();
            updateDisplay();

            Swal.fire({
                title: 'Payment Due Set',
                text: 'Payment due in 2 hours - you can see the countdown',
                icon: 'info'
            });
        }

        function setTrulyOverdue() {
            if (!subscriptionManager) return;
            subscriptionManager.subscriptionData = {
                status: 'active',
                plan: 'basic',
                trialStart: null,
                trialEnd: null,
                planStart: new Date(Date.now() - (15 * 24 * 60 * 60 * 1000)).toISOString(),
                planEnd: new Date(Date.now() + (15 * 24 * 60 * 60 * 1000)).toISOString(),
                amountOwing: 150.00,
                lastPaymentCheck: new Date().toISOString(),
                paymentDueDate: new Date(Date.now() - (2 * 60 * 60 * 1000)).toISOString(), // 2 hours ago
                isBlocked: true, // Blocked since payment is overdue
                blockedAt: new Date().toISOString(),
                paymentHistory: []
            };
            subscriptionManager.saveSubscriptionData();
            subscriptionManager.checkAccessControl();
            updateDisplay();

            Swal.fire({
                title: 'Truly Overdue Payment Set',
                text: 'Payment overdue by 2 hours - app should be blocked',
                icon: 'warning'
            });
        }

        function resetSystem() {
            localStorage.removeItem('subscriptionData');
            window.location.reload();
        }

        async function makePayment() {
            if (subscriptionManager) {
                await subscriptionManager.makePayment();
                updateDisplay();
            }
        }

        async function checkPayment() {
            if (subscriptionManager) {
                await subscriptionManager.checkPaymentStatus();
                updateDisplay();
            }
        }

        function goToSubscription() {
            window.location.href = 'subscription.html';
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                initTestPage();
            }, 1000);
        });
    </script>
</body>

</html>