<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription System Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .countdown-timer {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
    </style>
</head>

<body class="bg-black text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold mb-8 text-center">Subscription System Test</h1>

        <!-- Status Display -->
        <div class="bg-zinc-800 rounded-3xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Current Status</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-zinc-900 rounded-2xl p-4">
                    <div class="text-gray-400 text-sm">Status</div>
                    <div class="text-xl font-bold" id="status-display">Loading...</div>
                </div>
                <div class="bg-zinc-900 rounded-2xl p-4">
                    <div class="text-gray-400 text-sm">Plan</div>
                    <div class="text-xl font-bold" id="plan-display">Loading...</div>
                </div>
                <div class="bg-zinc-900 rounded-2xl p-4">
                    <div class="text-gray-400 text-sm">Amount Owing</div>
                    <div class="text-xl font-bold text-red-400" id="amount-display">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Countdown Display -->
        <div class="bg-zinc-800 rounded-3xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Countdown Timers</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-zinc-900 rounded-2xl p-4">
                    <div class="text-gray-400 text-sm">Trial/Plan Countdown</div>
                    <div class="text-2xl font-bold countdown-timer text-blue-400" id="main-countdown">Loading...</div>
                </div>
                <div class="bg-zinc-900 rounded-2xl p-4">
                    <div class="text-gray-400 text-sm">Payment Countdown</div>
                    <div class="text-2xl font-bold countdown-timer text-red-400" id="payment-countdown">No payment due
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="bg-zinc-800 rounded-3xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Test Controls</h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <button onclick="setFreeTrial()"
                    class="bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-semibold transition">
                    Free Trial
                </button>
                <button onclick="setBasicPlan()"
                    class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition">
                    Basic Plan
                </button>
                <button onclick="setExpired()"
                    class="bg-yellow-600 hover:bg-yellow-700 text-white py-3 px-4 rounded-lg font-semibold transition">
                    Expired
                </button>
                <button onclick="setPaymentDue()"
                    class="bg-orange-600 hover:bg-orange-700 text-white py-3 px-4 rounded-lg font-semibold transition">
                    Payment Due
                </button>
                <button onclick="setTrulyOverdue()"
                    class="bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-semibold transition">
                    Truly Overdue
                </button>
                <button onclick="resetSubscription()"
                    class="bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-lg font-semibold transition">
                    Reset
                </button>
                <button onclick="simulatePayment()"
                    class="bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-lg font-semibold transition">
                    ðŸ’³ Simulate Payment
                </button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="bg-zinc-800 rounded-3xl p-6">
            <h2 class="text-2xl font-bold mb-4">Actions</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="makePayment()"
                    class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-semibold transition">
                    <i class="fas fa-credit-card mr-2"></i>Make Payment
                </button>
                <button onclick="checkPayment()"
                    class="bg-gray-600 hover:bg-gray-700 text-white py-3 px-6 rounded-lg font-semibold transition">
                    <i class="fas fa-sync-alt mr-2"></i>Check Payment
                </button>
                <button onclick="goToSubscription()"
                    class="bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-semibold transition">
                    <i class="fas fa-cog mr-2"></i>Subscription Page
                </button>
            </div>
        </div>
    </div>

    <!-- Load Subscription Manager -->
    <script type="module" src="subscription-manager-v2.js"></script>
    <script type="module">
        // Import the subscription manager
        import { databases, DB_ID } from './js/config.js';
        
        let subscriptionManager = null;

        // Wait for subscription manager to be available
        function waitForManager() {
            return new Promise((resolve) => {
                const checkManager = setInterval(() => {
                    if (window.subscriptionManager) {
                        clearInterval(checkManager);
                        subscriptionManager = window.subscriptionManager;
                        resolve();
                    }
                }, 100);
            });
        }

        // Initialize the test page
        async function initTestPage() {
            try {
                await waitForManager();
                updateDisplay();
                startDisplayUpdates();
                console.log('Test page initialized successfully');
            } catch (error) {
                console.error('Failed to initialize test page:', error);
            }
        }

        // Update the display
        function updateDisplay() {
            if (!subscriptionManager || !subscriptionManager.subscriptionData) return;

            const data = subscriptionManager.subscriptionData;

            // Update status displays
            document.getElementById('status-display').textContent = data.status.replace('_', ' ').toUpperCase();
            document.getElementById('plan-display').textContent = data.plan_type ? data.plan_type.charAt(0).toUpperCase() + data.plan_type.slice(1) : 'N/A';
            document.getElementById('amount-display').textContent = `GHâ‚µ ${(data.amount_due || 0).toFixed(2)}`;

            // Update countdowns
            updateCountdowns();
        }

        // Update countdown displays
        function updateCountdowns() {
            if (!subscriptionManager || !subscriptionManager.subscriptionData) return;

            const data = subscriptionManager.subscriptionData;

            // Main countdown (trial or plan)
            let mainCountdown = 'No active countdown';
            if (data.status === 'active' && data.trial_end_date) {
                const timeLeft = new Date(data.trial_end_date) - new Date();
                if (timeLeft > 0) {
                    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    mainCountdown = `${days}d ${hours}h remaining`;
                } else {
                    mainCountdown = 'Trial Expired';
                }
            } else if (data.status === 'active' && data.end_date) {
                const timeLeft = new Date(data.end_date) - new Date();
                if (timeLeft > 0) {
                    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    mainCountdown = `${days}d ${hours}h remaining`;
                } else {
                    mainCountdown = 'Plan Expired';
                }
            }

            document.getElementById('main-countdown').textContent = mainCountdown;

            // Payment countdown
            let paymentCountdown = 'No payment due';
            if (data.payment_due_date) {
                const timeLeft = new Date(data.payment_due_date) - new Date();
                if (timeLeft > 0) {
                    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    paymentCountdown = `${hours}h ${minutes}m remaining`;
                } else {
                    paymentCountdown = 'PAYMENT OVERDUE';
                }
            }

            document.getElementById('payment-countdown').textContent = paymentCountdown;
        }

        // Start periodic display updates
        function startDisplayUpdates() {
            setInterval(() => {
                updateCountdowns();
            }, 1000);
        }

        // Test functions to simulate different subscription states
        window.setFreeTrial = async function() {
            try {
                const now = new Date();
                const trialEnd = new Date(now.getTime() + 20 * 24 * 60 * 60 * 1000); // 20 days
                
                const subscriptionData = {
                    subscription_id: 'test_' + Math.random().toString(36).substr(2, 16),
                    company_id: 'demo_company_001',
                    plan_type: 'free_trial',
                    status: 'active',
                    start_date: now.toISOString(),
                    end_date: trialEnd.toISOString(),
                    trial_end_date: trialEnd.toISOString(),
                    is_blocked: false,
                    created_at: now.toISOString(),
                    updated_at: now.toISOString()
                };
                
                await updateTestSubscription(subscriptionData);
                location.reload();
            } catch (error) {
                console.error('Error setting free trial:', error);
                showError('Failed to set free trial');
            }
        }

        window.setBasicPlan = async function() {
            try {
                const now = new Date();
                const planEnd = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000); // 30 days
                
                const subscriptionData = {
                    subscription_id: 'test_' + Math.random().toString(36).substr(2, 16),
                    company_id: 'demo_company_001',
                    plan_type: 'basic',
                    status: 'active',
                    start_date: now.toISOString(),
                    end_date: planEnd.toISOString(),
                    is_blocked: false,
                    last_payment_date: now.toISOString(),
                    created_at: now.toISOString(),
                    updated_at: now.toISOString()
                };
                
                await updateTestSubscription(subscriptionData);
                location.reload();
            } catch (error) {
                console.error('Error setting basic plan:', error);
                showError('Failed to set basic plan');
            }
        }

        window.setExpiredPlan = async function() {
            try {
                const now = new Date();
                const expiredDate = new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000); // 1 day ago
                const gracePeriod = new Date(now.getTime() + 6 * 24 * 60 * 60 * 1000); // 6 days from now
                
                const subscriptionData = {
                    subscription_id: 'test_' + Math.random().toString(36).substr(2, 16),
                    company_id: 'demo_company_001',
                    plan_type: 'basic',
                    status: 'expired',
                    start_date: new Date(now.getTime() - 31 * 24 * 60 * 60 * 1000).toISOString(),
                    end_date: expiredDate.toISOString(),
                    is_blocked: true,
                    blocked_at: now.toISOString(),
                    payment_due_date: gracePeriod.toISOString(),
                    grace_period_end: gracePeriod.toISOString(),
                    amount_due: 29.99,
                    created_at: now.toISOString(),
                    updated_at: now.toISOString()
                };
                
                await updateTestSubscription(subscriptionData);
                location.reload();
            } catch (error) {
                console.error('Error setting expired:', error);
                showError('Failed to set expired status');
            }
        }

        window.setOverduePayment = async function() {
            try {
                const now = new Date();
                const expiredDate = new Date(now.getTime() - 5 * 24 * 60 * 60 * 1000); // 5 days ago
                const gracePeriod = new Date(now.getTime() + 2 * 24 * 60 * 60 * 1000); // 2 days from now
                
                const subscriptionData = {
                    subscription_id: 'test_' + Math.random().toString(36).substr(2, 16),
                    company_id: 'demo_company_001',
                    plan_type: 'basic',
                    status: 'expired',
                    start_date: new Date(now.getTime() - 35 * 24 * 60 * 60 * 1000).toISOString(),
                    end_date: expiredDate.toISOString(),
                    is_blocked: true,
                    blocked_at: expiredDate.toISOString(),
                    payment_due_date: gracePeriod.toISOString(),
                    grace_period_end: gracePeriod.toISOString(),
                    amount_due: 29.99,
                    created_at: now.toISOString(),
                    updated_at: now.toISOString()
                };
                
                await updateTestSubscription(subscriptionData);
                location.reload();
            } catch (error) {
                console.error('Error setting payment due:', error);
                showError('Failed to set payment due status');
            }
        }

        window.setTrulyOverdue = async function() {
            try {
                const now = new Date();
                const expiredDate = new Date(now.getTime() - 10 * 24 * 60 * 60 * 1000); // 10 days ago
                const paymentDue = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000); // 3 days ago
                
                const subscriptionData = {
                    subscription_id: 'test_' + Math.random().toString(36).substr(2, 16),
                    company_id: 'demo_company_001',
                    plan_type: 'basic',
                    status: 'payment_overdue',
                    start_date: new Date(now.getTime() - 40 * 24 * 60 * 60 * 1000).toISOString(),
                    end_date: expiredDate.toISOString(),
                    is_blocked: true,
                    blocked_at: expiredDate.toISOString(),
                    payment_due_date: paymentDue.toISOString(),
                    grace_period_end: paymentDue.toISOString(),
                    amount_due: 29.99,
                    created_at: now.toISOString(),
                    updated_at: now.toISOString()
                };
                
                await updateTestSubscription(subscriptionData);
                location.reload();
            } catch (error) {
                console.error('Error setting truly overdue:', error);
                showError('Failed to set overdue status');
            }
        }

        window.resetSystem = async function() {
            try {
                // Delete existing subscription from Appwrite
                const response = await databases.listDocuments(
                    DB_ID,
                    'subscriptions',
                    [databases.Query.equal('company_id', 'demo_company_001')]
                );
                
                for (const doc of response.documents) {
                    await databases.deleteDocument(DB_ID, 'subscriptions', doc.$id);
                }
                
                // Also clear localStorage as fallback
                localStorage.removeItem("subscriptionData");
                location.reload();
            } catch (error) {
                console.error('Error resetting subscription:', error);
                showError('Failed to reset subscription');
            }
        }

        // Helper function to update test subscription
        async function updateTestSubscription(subscriptionData) {
            try {
                // First, delete any existing subscription for this company
                const existing = await databases.listDocuments(
                    DB_ID,
                    'subscriptions',
                    [databases.Query.equal('company_id', subscriptionData.company_id)]
                );
                
                for (const doc of existing.documents) {
                    await databases.deleteDocument(DB_ID, 'subscriptions', doc.$id);
                }
                
                // Create new subscription
                await databases.createDocument(
                    DB_ID,
                    'subscriptions',
                    subscriptionData.subscription_id,
                    subscriptionData
                );
                
                console.log('Test subscription updated:', subscriptionData);
            } catch (error) {
                console.error('Error updating test subscription:', error);
                throw error;
            }
        }

        // Helper function to show errors
        function showError(message) {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: 'Error',
                    text: message,
                    icon: 'error',
                    background: '#1F2937',
                    color: '#F9FAFB'
                });
            } else {
                alert(message);
            }
        }

        async function makePayment() {
            if (subscriptionManager) {
                await subscriptionManager.makePayment();
                updateDisplay();
            }
        }

        async function checkPayment() {
            if (subscriptionManager) {
                await subscriptionManager.checkPaymentStatus();
                updateDisplay();
            }
        }

        function goToSubscription() {
            window.location.href = 'subscription.html';
        }

        // Test payment simulation
        window.simulatePayment = async function() {
            if (window.subscriptionManager && window.subscriptionManager.subscription) {
                await window.subscriptionManager.paymentProcessor.showPaymentModal(window.subscriptionManager.subscription);
            } else {
                showError('No subscription found to process payment for');
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                initTestPage();
            }, 1000);
        });
    </script>
</body>

</html>