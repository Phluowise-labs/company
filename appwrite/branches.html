<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Branches</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="../images/Phluowise_Business_icon.svg" type="image/x-icon" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>

<body class="bg-black flex items-center justify-center min-h-screen p-4" style="font-family: 'Inter', sans-serif">
  <style>
    /* Glassmorphism scrollbar styles */
    .scrollbar-glass::-webkit-scrollbar {
      width: 4px;
      margin: 10px;
    }

    .scrollbar-glass::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 10px;
    }

    .scrollbar-glass::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .scrollbar-glass::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.4);
    }
  </style>
  <button onclick="navigateBack()"
    class="fixed top-10 left-4 flex items-center text-white/70 hover:text-white transition duration-300 z-50">
    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
    </svg>
    <span class="text-base font-medium">Back</span>
  </button>

  <div class="bg-[#F5F5F51A] border-gray-700 text-white rounded-lg p-8 w-full max-w-md">
    <h2 class="text-center text-2xl font-semibold text-white mb-6">
      Branches Settings
    </h2>
    <!-- Search bar -->
    <input type="text" id="searchInput" placeholder="Search..."
      class="w-full mb-4 px-4 py-2 rounded bg-[#1c1c1c] text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-600" />

    <div class="overflow-y-auto h-[calc(70vh-80px)] pb-3 mb-5 scrollbar-glass">
      <!-- Dynamic list of branches -->
      <div id="branches-list"></div>
    </div>
    <!-- Buttons -->
    <a href="create_branch.html">
      <button class="w-full bg-[#007ACC99] text-white py-2 rounded-lg mb-4">
        Create Branch Space
      </button>
    </a>
    <button id="deleteBtn" class="w-full bg-transparent text-red-500 py-2 rounded-lg border border-red-500 mb-4 hidden"
      onclick="deleteSelectedBranches()">
      Delete Selected Branches
    </button>
  </div>

  <script type="module">
    import { databases, DB_ID, BRANCH_COLL, COMPANY_COLL, Appwrite, account, isCompanyAdminBranch } from "./js/config.js";

    const listContainer = document.getElementById("branches-list");
    const searchInput = document.getElementById("searchInput");
    let branches = [];

    // Show loading animation
    function showLoading() {
      listContainer.innerHTML = `
          <div class="flex justify-center items-center py-8">
            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
            <span class="ml-3 text-white">Loading branches...</span>
          </div>
        `;
    }

    // Hide loading animation
    function hideLoading() {
      listContainer.innerHTML = '';
    }

    // Fetch branches from Appwrite DB
    async function fetchBranches() {
      showLoading();
      try {
        const user = await account.get();
        const companyId = user.$id;

        if (!companyId) {
          listContainer.innerHTML = `<p class="text-white text-center">Please log in as a company admin first.</p>`;
          return;
        }

        // Fetch company details to get the main branch ID
        const companyResult = await databases.getDocument(DB_ID, COMPANY_COLL, companyId);
        const mainBranchId = companyResult.main_branch_id;

        console.log('Company ID:', companyId);
        console.log('Company Result:', companyResult);
        console.log('Main Branch ID:', mainBranchId);
        console.log('Main Branch Available:', !!mainBranchId);

        if (!mainBranchId) {
          console.warn('No main branch ID found in company document. All branches will be toggleable.');
        }

        // Fetch branches from Appwrite DB
        const result = await databases.listDocuments(
          DB_ID,
          BRANCH_COLL,
          [Appwrite.Query.equal("company_id", companyId)]
        );

        if (result.documents) {
          branches = result.documents.map(branch => ({
            branchId: branch.branch_id,
            documentId: branch.$id, // Store document ID for database updates
            branchName: branch.branch_name || "",
            branchLocation: branch.location || "",
            branchCode: branch.branch_code || "",
            status: branch.is_active ? "active" : "inactive",
            isActive: branch.is_active || false,
            isMainBranch: isCompanyAdminBranch(branch, companyId)
          }));

          console.log('All Branches:', branches);
          console.log('Main Branch Found:', branches.find(branch => branch.isMainBranch));
          console.log('Branches with Main Branch Status:', branches.map(branch => ({
            name: branch.branchName,
            id: branch.branchId,
            isMainBranch: branch.isMainBranch
          })));

          // Debug: Show company_id vs branch_id comparison
          console.log('Company ID vs Branch IDs comparison:');
          result.documents.forEach(branch => {
            console.log(`Branch: ${branch.branch_name}, company_id: ${branch.company_id}, branch_id: ${branch.branch_id}, isCompanyAdmin: ${isCompanyAdminBranch(branch, companyId)}`);
          });

          hideLoading();
          renderBranches();
        } else {
          hideLoading();
          listContainer.innerHTML = `<p class="text-white text-center">No branches found.</p>`;
        }
      } catch (error) {
        hideLoading();
        listContainer.innerHTML = `<p class="text-white text-center">Error: ${error.message}</p>`;
      }
    }

    function renderBranches(filter = "") {
      const filteredBranches = branches.filter(
        (branch) =>
          branch.branchName.toLowerCase().includes(filter.toLowerCase()) ||
          branch.branchLocation
            .toLowerCase()
            .includes(filter.toLowerCase()) ||
          branch.branchCode.toLowerCase().includes(filter.toLowerCase())
      );

      if (filteredBranches.length === 0) {
        listContainer.innerHTML = `<p class="text-white text-center">No matching branches found.</p>`;
        return;
      }

      listContainer.innerHTML = filteredBranches
        .map(
          (branch, index) => {
            return `
                <div x-data="{ toggle: ${branch.isActive}, isUpdating: false, selected: false }" data-branch-id="${branch.branchId}" data-document-id="${branch.documentId}" class="bg-[#060606B2] p-4 rounded-lg mb-6 transition-all duration-200" :class="selected ? 'border border-red-500 bg-red-900/10' : ''">
                    <div class="flex items-center">
                        <!-- Selection Checkbox -->
                        <div class="flex items-center mr-3">
                            <input type="checkbox" x-model="selected" @change="updateDeleteButton()" class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500 focus:ring-2" ${branch.isMainBranch ? 'disabled' : ''}>
                        </div>
                        
                        <!-- Branch Icon -->
                        <div class="flex mb-5 mr-3">
                            <img alt="Branch icon" class="mr-2" height="24" src="../images/shop.png" width="24" />
                        </div>
                        
                        <!-- Branch Details -->
                        <div class="flex-1">
                            <div class="text-lg font-semibold">${branch.branchName} ${branch.isMainBranch ? '(Main Branch)' : ''}</div>
                            <div class="text-gray-400">${branch.branchLocation}</div>
                            <div class="text-gray-400 text-sm">${branch.branchCode}</div>
                        </div>
                        
                        <!-- Status Toggle -->
                        <div>
                            ${branch.isMainBranch ?
                `<div class="text-green-400 text-sm font-medium px-3 py-1 bg-green-900/20 rounded-full">
                                Always Active
                              </div>` :
                `<div class="flex items-center">
                                <input type="checkbox" id="toggleBranch${index}" x-model="toggle" @change="toggleBranchStatus('${branch.branchId}', toggle)" class="hidden">
                                <label for="toggleBranch${index}"
                                    class="w-11 h-6 flex items-center bg-gray-800 rounded-full cursor-pointer p-1 transition duration-300"
                                    :class="toggle ? 'bg-green-600' : 'bg-gray-700'"
                                    :disabled="isUpdating">
                                    <div class="w-4 h-4 bg-white rounded-full transition-transform duration-300"
                                        :class="toggle ? 'translate-x-5' : 'translate-x-0'">
                                    </div>
                                </label>
                                <div x-show="isUpdating" class="ml-2">
                                  <div class="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-blue-500"></div>
                                </div>
                              </div>`
              }
                        </div>
                    </div>
                </div>
            `;
          }
        )
        .join("");
    }

    // Toggle branch status function
    async function toggleBranchStatus(branchId, isActive) {
      try {
        // Find the branch element and set updating state
        const branchElement = document.querySelector(`[data-branch-id="${branchId}"]`);
        if (branchElement) {
          const alpineData = Alpine.$data(branchElement);
          alpineData.isUpdating = true;
        }

        // Find the branch to get its document ID
        const branch = branches.find(b => b.branchId === branchId);
        if (!branch) {
          throw new Error('Branch not found');
        }

        // Update the branch status in Appwrite
        await databases.updateDocument(
          DB_ID,
          BRANCH_COLL,
          branch.documentId,
          {
            is_active: isActive
          }
        );

        // Update the local branches array
        const branchIndex = branches.findIndex(branch => branch.branchId === branchId);
        if (branchIndex !== -1) {
          branches[branchIndex].isActive = isActive;
          branches[branchIndex].status = isActive ? "active" : "inactive";
        }

        // Show success message
        Swal.fire({
          title: 'Success!',
          text: `Branch has been ${isActive ? 'activated' : 'deactivated'} successfully.`,
          icon: 'success',
          timer: 2000,
          showConfirmButton: false,
          toast: true,
          position: 'top-end'
        });

      } catch (error) {
        console.error('Error updating branch status:', error);

        // Show error message
        Swal.fire({
          title: 'Error!',
          text: `Failed to update branch status: ${error.message}`,
          icon: 'error',
          timer: 3000,
          showConfirmButton: false,
          toast: true,
          position: 'top-end'
        });

        // Revert the toggle state
        const branchElement = document.querySelector(`[data-branch-id="${branchId}"]`);
        if (branchElement) {
          const alpineData = Alpine.$data(branchElement);
          alpineData.toggle = !isActive;
        }
      } finally {
        // Reset updating state
        const branchElement = document.querySelector(`[data-branch-id="${branchId}"]`);
        if (branchElement) {
          const alpineData = Alpine.$data(branchElement);
          alpineData.isUpdating = false;
        }
      }
    }

    // Make toggleBranchStatus globally available
    window.toggleBranchStatus = toggleBranchStatus;

    // Update delete button visibility
    function updateDeleteButton() {
      const selectedBranches = document.querySelectorAll('[data-branch-id]');
      const deleteBtn = document.getElementById('deleteBtn');
      let hasSelected = false;

      selectedBranches.forEach(branchElement => {
        const alpineData = Alpine.$data(branchElement);
        if (alpineData && alpineData.selected) {
          hasSelected = true;
        }
      });

      if (hasSelected) {
        deleteBtn.classList.remove('hidden');
      } else {
        deleteBtn.classList.add('hidden');
      }
    }

    // Delete selected branches function
    async function deleteSelectedBranches() {
      const selectedBranches = [];
      const branchElements = document.querySelectorAll('[data-branch-id]');

      branchElements.forEach(branchElement => {
        const alpineData = Alpine.$data(branchElement);
        if (alpineData && alpineData.selected) {
          const branchId = branchElement.getAttribute('data-branch-id');
          const documentId = branchElement.getAttribute('data-document-id');
          const branchName = branchElement.querySelector('.text-lg').textContent.replace(' (Main Branch)', '');
          selectedBranches.push({ branchId, documentId, branchName });
        }
      });

      if (selectedBranches.length === 0) {
        Swal.fire({
          icon: 'warning',
          title: 'No Branch Selected!',
          text: 'Please select at least one branch to delete.',
          confirmButtonText: 'OK',
          buttonsStyling: false,
          customClass: {
            popup: 'bg-[#121212] rounded-lg shadow-lg',
            title: 'text-white',
            confirmButton: 'bg-blue-700 text-white py-2 px-6 rounded-full mx-2',
          },
        });
        return;
      }

      Swal.fire({
        title: 'Delete Selected Branches?',
        html: `<div style="font: Inter; font-weight: 200; font-size: 20px; line-height: 100%; letter-spacing: 0%; text-align: center;">
              <p>You are about to delete this branch space.</p><br>
              <p style="color: rgba(255, 255, 255, 0.7);">This action cannot be undone. This will delete all the data and files associated with the selected branches. This will also delete the branches from the database and the associated user accounts. You are about to delete ${selectedBranches.length} branch(es). Are you sure you want to delete?</p>
              </div>`,
        showCancelButton: true,
        confirmButtonText: 'Delete',
        cancelButtonText: 'Cancel',
        buttonsStyling: false,
        customClass: {
          popup: 'bg-[#121212] rounded-lg shadow-lg',
          title: 'hidden',
          htmlContainer: 'text-white text-center',
          confirmButton: 'bg-red-600 text-white py-2 px-6 rounded-full mx-2',
          cancelButton: 'bg-gray-600 text-white py-2 px-6 rounded-full mx-2'
        },
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            // Delete each selected branch
            for (const branch of selectedBranches) {
              // Delete the branch document from database
              await databases.deleteDocument(
                DB_ID,
                BRANCH_COLL,
                branch.documentId
              );

              // Delete the associated user account
              try {
                await account.deleteIdentity(branch.branchId);
              } catch (userDeleteError) {
                console.warn(`Could not delete user account for branch ${branch.branchId}:`, userDeleteError);
              }

              console.log(`Branch ${branch.branchName} and associated user account deleted successfully`);
            }

            // Refresh the branches list
            await fetchBranches();

            Swal.fire({
              icon: 'success',
              title: 'Branches Deleted!',
              text: 'Branches and associated user accounts have been deleted successfully.',
              showConfirmButton: false,
              timer: 2000,
              customClass: {
                popup: 'bg-[#121212] rounded-lg shadow-lg',
                title: 'text-white'
              },
            });
          } catch (error) {
            console.error('Error deleting branches:', error);
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: `Failed to delete branches: ${error.message}`,
              customClass: {
                popup: 'bg-[#121212] rounded-lg shadow-lg',
                title: 'text-white'
              },
            });
          }
        }
      });
    }

    // Intelligent navigation function
    function navigateBack() {
      // Get the referrer (previous page)
      const referrer = document.referrer;

      // Check if we have a referrer and it's from the same domain
      if (referrer && referrer.includes(window.location.origin)) {
        // Extract the page name from the referrer
        const referrerPath = new URL(referrer).pathname;
        const currentPath = window.location.pathname;

        // If we came from create_branch.html, go to home instead
        if (referrerPath.includes('create_branch.html')) {
          // Check if we have a stored home page reference
          const homePage = sessionStorage.getItem('homePage') || 'home.html';
          window.location.href = homePage;
          return;
        }

        // If we came from the same page (refresh), go to home
        if (referrerPath === currentPath) {
          const homePage = sessionStorage.getItem('homePage') || 'home.html';
          window.location.href = homePage;
          return;
        }

        // Otherwise, go back to the referrer
        window.location.href = referrer;
      } else {
        // No referrer or external referrer, go to home
        const homePage = sessionStorage.getItem('homePage') || 'home.html';
        window.location.href = homePage;
      }
    }

    // Make functions globally available
    window.updateDeleteButton = updateDeleteButton;
    window.deleteSelectedBranches = deleteSelectedBranches;
    window.navigateBack = navigateBack;

    searchInput.addEventListener("input", () =>
      renderBranches(searchInput.value)
    );

    // Store home page reference when page loads
    document.addEventListener('DOMContentLoaded', function () {
      // If we don't have a home page stored, try to determine it from referrer
      if (!sessionStorage.getItem('homePage')) {
        const referrer = document.referrer;
        if (referrer && referrer.includes(window.location.origin)) {
          const referrerPath = new URL(referrer).pathname;
          if (referrerPath.includes('home.html') || referrerPath.includes('workspace.html')) {
            sessionStorage.setItem('homePage', referrerPath.split('/').pop());
          }
        }
      }

      // Load branches
      fetchBranches();
    });
  </script>
</body>

</html>